---
import RichText from '@/components/richtext.astro';
import TableOfContents from '@/components/table-of-contents.astro';
import type { ArticleStoryblok } from '@/types/storyblok';
import { calculateReadingTime, extractHeadingsFromRichText, parseStoryblokImage } from '@/utils/storyblok';
import type { ISbStoryData } from '@storyblok/astro';
import { storyblokEditable } from '@storyblok/astro';

interface AstroProps {
  blok: ArticleStoryblok;
  story: ISbStoryData<ArticleStoryblok>;
}

const { blok, story } = Astro.props as AstroProps;

const headings = extractHeadingsFromRichText(blok.content);
const readingTime = calculateReadingTime(blok.content);
---

<article {...storyblokEditable(blok)} class="container">
  <div class="mx-auto max-w-3xl xl:max-w-none">
    <header class="max-w-[49rem]">
      <p>{readingTime === 1 ? '1 minute de lecture' : `${readingTime} minutes de lecture`}</p>
      <h1 class="font-heading mt-6 text-4xl font-bold text-pretty text-gray-950">
        {story.name}
      </h1>
      <p class="mt-4 text-lg text-gray-700">{blok.description}</p>
    </header>
    <div
      class="mx-auto mt-12 xl:grid xl:max-w-none xl:grid-cols-[49rem_1fr] xl:items-start xl:gap-x-20"
    >
      <aside class="sticky top-28 order-last hidden xl:block">
        <TableOfContents headings={headings} />
      </aside>
      <div>
        <div
          class="relative mb-12 aspect-[1200/630] overflow-hidden rounded-2xl bg-gray-950/5 shadow-[0_2px_10px] shadow-gray-900/20"
        >
          <img
            {...parseStoryblokImage(blok.cover)}
            class="absolute inset-0 size-full object-cover"
            style="color: transparent;"
          />
        </div>
        <div
          class="prose prose-headings:font-heading prose-h2:mb-4 prose-h2:mt-16 prose-h3:mb-4 prose-h3:mt-12 prose-h4:mb-4 prose-h4:mt-8 prose-p:mb-7 prose-p:mt-0 prose-p:text-base prose-p:text-gray-700 prose-code:rounded-md prose-code:border prose-code:border-gray-200 prose-code:bg-white prose-code:px-1.5 prose-code:py-1 prose-code:font-medium prose-code:before:content-none prose-code:after:content-none prose-ol:my-7 prose-ul:my-7 prose-li:text-base prose-li:text-gray-700 max-w-none [&_:is(h1,h2,h3,h4,h5)+*]:mt-0"
        >
          <RichText text={blok.content} />
        </div>
      </div>
    </div>
  </div>
</article>
